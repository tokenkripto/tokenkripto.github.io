<!DOCTYPE html>
<html lang="id">

<head>
    <meta charset="UTF-8">
    <link rel="shortcut icon" type="image/png" href="https://tokenkripto.github.io/favicon.png" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="DApp Web3 Penjualan Token DANA - Beli token DANA dengan BNB di BNB Chain">
    <meta name="keywords" content="DANA, Danacoin, Token DANA, DANA Presale, BNB Smart Chain, BNB, Crypto">
    <title>Danacoin Token Sale - Beli Token DANA Jaringan BNB Smart Chain</title>
    <script src="https://cdn.jsdelivr.net/npm/web3@latest/dist/web3.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary: #10d906;
            --primary-dark: #0a8f04;
            --primary-light: #2EF0CC;
            --secondary: #87CEEB;
            --accent: #FF6B6B;
            --dark: #0A0F1C;
            --darker: #050A14;
            --light: #F8FAFC;
            --gray: #94A3B8;
            --success: #00D4AA;
            --warning: #FFA502;
            --card-bg: rgba(255, 255, 255, 0.05);
            --card-border: rgba(255, 255, 255, 0.08);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
        }

        body {
            background: linear-gradient(135deg, var(--darker) 0%, var(--dark) 100%);
            color: var(--light);
            min-height: 100vh;
            line-height: 1.6;
        }

        .container {
            max-width: 500px;
            margin: 0 auto;
            padding: 15px;
        }

        .header-banner {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 20px;
            text-align: center;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.3);
        }

        .logo {
            width: 80px;
            height: 80px;
            margin: 0 auto 15px;
            border-radius: 50%;
            overflow: hidden;
            border: 3px solid white;
        }

        .logo img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        h1 {
            font-size: 24px;
            font-weight: 800;
            margin-bottom: 5px;
            color: white;
        }

        .subtitle {
            font-size: 14px;
            opacity: 0.9;
        }

        .card {
            background: var(--card-bg);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 15px;
            border: 1px solid var(--card-border);
        }

        .card-title {
            font-size: 16px;
            font-weight: 700;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .card-title i {
            color: var(--primary);
        }

        .info-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
        }

        @media (max-width: 480px) {
            .info-grid {
                grid-template-columns: 1fr;
            }
        }

        .info-item {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            padding: 15px;
            text-align: center;
        }

        .info-item-full {
            grid-column: 1 / -1;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            padding: 15px;
            text-align: center;
            margin-top: 5px;
        }

        .info-label {
            font-size: 12px;
            opacity: 0.8;
            margin-bottom: 8px;
        }

        .info-value {
            font-size: 16px;
            font-weight: 700;
        }

        .wallet-display {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 15px;
        }

        .wallet-address {
            margin-bottom: 12px;
            text-align: center;
        }

        .address-label {
            font-size: 13px;
            opacity: 0.8;
            margin-bottom: 5px;
        }

        .address {
            font-family: monospace;
            font-size: 14px;
            background: rgba(0, 0, 0, 0.2);
            padding: 10px 12px;
            border-radius: 8px;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .wallet-balance {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }

        .balance-label {
            font-size: 13px;
            opacity: 0.8;
        }

        .balance-value {
            font-size: 15px;
            font-weight: 700;
        }

        .form-group {
            margin-bottom: 15px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-size: 14px;
        }

        input {
            width: 100%;
            padding: 12px 15px;
            border-radius: 10px;
            border: 1px solid rgba(255, 255, 255, 0.15);
            background: rgba(255, 255, 255, 0.08);
            color: white;
            font-size: 14px;
        }

        input:focus {
            outline: none;
            border-color: var(--primary);
        }

        .btn {
            display: block;
            width: 100%;
            padding: 12px;
            border: none;
            border-radius: 10px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            text-align: center;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            color: white;
        }

        .btn-success {
            background: linear-gradient(135deg, var(--success) 0%, var(--primary-dark) 100%);
            color: white;
        }

        .btn-warning {
            background: linear-gradient(135deg, var(--accent) 0%, var(--accent) 100%);
            color: white;
        }

        .btn-outline {
            background: transparent;
            color: var(--primary-light);
            border: 1px solid var(--primary);
        }

        .token-estimate {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 8px;
            padding: 12px;
            margin-top: 10px;
            text-align: center;
            font-size: 13px;
        }

        .token-estimate strong {
            font-size: 14px;
        }

        .loader {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 1s ease-in-out infinite;
            margin-right: 8px;
        }

        .footer {
            text-align: center;
            margin-top: 25px;
            padding: 20px 0;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }

        .footer-links {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-bottom: 12px;
            flex-wrap: wrap;
        }

        .footer-link {
            color: rgba(255, 255, 255, 0.7);
            text-decoration: none;
            font-size: 13px;
            display: flex;
            align-items: center;
            gap: 5px;
            padding: 5px 10px;
        }

        .copyright {
            color: rgba(255, 255, 255, 0.5);
            font-size: 11px;
        }

        .status-badge {
            display: inline-flex;
            align-items: center;
            gap: 5px;
            padding: 4px 8px;
            border-radius: 15px;
            font-size: 11px;
            font-weight: 600;
            margin-left: 8px;
        }

        .status-connected {
            background: rgba(0, 212, 170, 0.2);
            color: var(--success);
        }

        .status-disconnected {
            background: rgba(255, 107, 107, 0.2);
            color: var(--accent);
        }

        .hidden {
            display: none !important;
        }

        .success-purchase {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.85);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 2000;
            padding: 15px;
        }

        .success-content {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            padding: 25px;
            text-align: center;
            max-width: 90%;
            width: 350px;
            position: relative;
        }

        .close-modal {
            position: absolute;
            top: 15px;
            right: 15px;
            background: none;
            border: none;
            font-size: 20px;
            color: var(--gray);
            cursor: pointer;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
        }

        .close-modal:hover {
            background: rgba(0, 0, 0, 0.1);
        }

        .success-icon {
            font-size: 50px;
            color: var(--success);
            margin-bottom: 15px;
        }

        .success-title {
            font-size: 20px;
            font-weight: 800;
            margin-bottom: 10px;
            color: var(--dark);
        }

        .success-message {
            font-size: 14px;
            color: var(--gray);
            margin-bottom: 20px;
        }

        .add-token-btn {
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 10px;
            padding: 10px 15px;
            font-size: 13px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 5px;
            width: 100%;
        }

        .footer-action-btn {
            background: transparent;
            color: var(--primary-light);
            border: 1px solid var(--primary);
            border-radius: 8px;
            padding: 8px 12px;
            font-size: 12px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 5px;
            margin: 0 auto;
        }

        .notification-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.85);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 2000;
            padding: 15px;
        }

        .notification-content {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            padding: 25px;
            text-align: center;
            max-width: 90%;
            width: 350px;
            position: relative;
        }

        .notification-icon {
            font-size: 50px;
            margin-bottom: 15px;
        }

        .notification-success {
            color: var(--success);
        }

        .notification-error {
            color: var(--accent);
        }

        .notification-info {
            color: var(--primary);
        }

        .notification-title {
            font-size: 20px;
            font-weight: 800;
            margin-bottom: 10px;
            color: var(--dark);
        }

        .notification-message {
            font-size: 14px;
            color: var(--gray);
            margin-bottom: 20px;
            line-height: 1.4;
        }

        .notification-close-btn {
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 10px;
            padding: 10px 15px;
            font-size: 13px;
            cursor: pointer;
            width: 100%;
        }

        .mobile-browser-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.85);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 2000;
            padding: 15px;
        }

        .mobile-browser-content {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            padding: 25px;
            text-align: center;
            max-width: 90%;
            width: 350px;
            position: relative;
        }

        .mobile-browser-icon {
            font-size: 50px;
            color: var(--warning);
            margin-bottom: 15px;
        }

        .mobile-browser-title {
            font-size: 20px;
            font-weight: 800;
            margin-bottom: 10px;
            color: var(--dark);
        }

        .mobile-browser-message {
            font-size: 14px;
            color: var(--gray);
            margin-bottom: 20px;
            line-height: 1.4;
        }

        .instruction-list {
            text-align: left;
            margin-bottom: 20px;
            background: rgba(0, 0, 0, 0.03);
            border-radius: 12px;
            padding: 16px;
        }

        .instruction-list ol {
            padding-left: 20px;
            margin-bottom: 0;
        }

        .instruction-list li {
            margin-bottom: 8px;
            color: var(--gray);
            line-height: 1.4;
            font-size: 13px;
        }

        .instruction-list li:last-child {
            margin-bottom: 0;
        }

        .copy-url {
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 10px;
            padding: 10px 15px;
            font-size: 13px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 5px;
            width: 100%;
        }

        .network-warning-blink {
            animation: networkBlink 2s infinite;
            border: 2px solid #FF4444;
            box-shadow: 0 0 20px rgba(255, 68, 68, 0.5);
        }

        @keyframes networkBlink {
            0% {
                background: rgba(255, 68, 68, 0.2);
                border-color: #FF4444;
                box-shadow: 0 0 20px rgba(255, 68, 68, 0.5);
            }

            50% {
                background: rgba(255, 165, 0, 0.3);
                border-color: #FFA500;
                box-shadow: 0 0 25px rgba(255, 165, 0, 0.7);
            }

            100% {
                background: rgba(255, 68, 68, 0.2);
                border-color: #FF4444;
                box-shadow: 0 0 20px rgba(255, 68, 68, 0.5);
            }
        }

        .btn-warning-blink {
            animation: buttonBlink 1.5s infinite;
            font-weight: bold;
            transform: scale(1.02);
        }

        @keyframes buttonBlink {
            0% {
                background: linear-gradient(135deg, #FF4444 0%, #CC0000 100%);
                box-shadow: 0 0 15px rgba(255, 68, 68, 0.7);
            }

            50% {
                background: linear-gradient(135deg, #FFA500 0%, #FF8C00 100%);
                box-shadow: 0 0 20px rgba(255, 165, 0, 0.8);
            }

            100% {
                background: linear-gradient(135deg, #FF4444 0%, #CC0000 100%);
                box-shadow: 0 0 15px rgba(255, 68, 68, 0.7);
            }
        }

        .warning-icon-blink {
            animation: iconBlink 1s infinite;
        }

        @keyframes iconBlink {
            0% {
                color: #FF4444;
                transform: scale(1);
            }

            50% {
                color: #FFA500;
                transform: scale(1.1);
            }

            100% {
                color: #FF4444;
                transform: scale(1);
            }
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }
    </style>
</head>

<body>

    <div class="success-purchase" id="successPurchase">
        <div class="success-content">
            <button class="close-modal" id="closeSuccessBtn">
                <i class="fas fa-times"></i>
            </button>
            <div class="success-icon">
                <i class="fas fa-check-circle"></i>
            </div>
            <h2 class="success-title">Pembelian Berhasil!</h2>
            <p class="success-message" id="successMessage">
                Terima kasih telah membeli token DANA!
            </p>
            <button class="add-token-btn" id="addTokenBtn">
                <i class="fas fa-plus-circle"></i> Add DANA to Wallet
            </button>
        </div>
    </div>

    <div class="notification-modal" id="notificationModal">
        <div class="notification-content">
            <div class="notification-icon" id="notificationIcon">
                <i class="fas fa-check-circle notification-success"></i>
            </div>
            <h2 class="notification-title" id="notificationTitle">Success</h2>
            <p class="notification-message" id="notificationMessage">
                Your operation was successful!
            </p>
            <button class="notification-close-btn" id="notificationCloseBtn">
                Tutup
            </button>
        </div>
    </div>

    <div class="mobile-browser-modal" id="mobileBrowserModal">
        <div class="mobile-browser-content">
            <button class="close-modal" id="closeMobileBrowserModal">
                <i class="fas fa-times"></i>
            </button>
            <div class="mobile-browser-icon">
                <i class="fas fa-exclamation-triangle"></i>
            </div>
            <h2 class="mobile-browser-title">Akses Wallet Diperlukan</h2>
            <p class="mobile-browser-message">
                Untuk terhubung dengan aplikasi ini, Anda perlu mengakses melalui DApp Browser di wallet crypto Anda.
            </p>

            <div class="instruction-list">
                <ol>
                    <li>Buka aplikasi wallet (MetaMask, Trust Wallet, Bitget Wallet, dll.) di ponsel Anda</li>
                    <li>Cari dan buka menu "Browser" atau "DApp Browser"</li>
                    <li>Tempel URL berikut di browser DApp:</li>
                </ol>
            </div>

            <button class="copy-url" id="copyUrlBtn">
                <i class="far fa-copy"></i> Salin URL
            </button>
        </div>
    </div>

    <main class="container">
        <header class="header-banner">
            <div class="logo">
                <img src="https://raw.githubusercontent.com/cryptorecehcom/images/refs/heads/main/tokenlogo/DANA.png"
                    alt="DANA Logo">
            </div>
            <h1>Danacoin (DANA) Token Sale</h1>
            <p class="subtitle">Beli Token DANA jaringan BNB Smart Chain</p>
        </header>

        <section id="connectWallet" class="card">
            <div class="card-title">
                <i class="fas fa-wallet"></i>
                <span>Hubungkan Wallet</span>
                <span id="connectionStatus" class="status-badge status-disconnected hidden">
                    <i class="fas fa-circle"></i> Terputus
                </span>
            </div>
            <p style="margin-bottom: 15px; font-size: 13px; opacity: 0.8;">
                Sambungkan wallet untuk membeli token DANA
            </p>
            <button id="connectWalletBtn" class="btn btn-success">
                <i class="fas fa-plug"></i> Connect Wallet
            </button>
        </section>

        <section id="networkWarning" class="card hidden">
            <div class="card-title">
                <i class="fas fa-exclamation-triangle warning-icon-blink"></i>
                <span>Jaringan Salah</span>
            </div>
            <p style="margin-bottom: 12px; font-size: 13px; opacity: 0.8;">
                ⚠️ Silakan ganti ke jaringan BNB Chain untuk melanjutkan
            </p>
            <button id="switchNetworkBtn" class="btn btn-warning-blink">
                <i class="fas fa-exchange-alt"></i> Ganti Jaringan
            </button>
        </section>

        <section id="connectedWallet" class="card hidden">
            <div class="card-title">
                <i class="fas fa-check-circle"></i>
                <span>Wallet Terhubung</span>
                <span class="status-badge status-connected">
                    <i class="fas fa-circle"></i> Terhubung
                </span>
            </div>

            <div class="wallet-display">
                <div class="wallet-address">
                    <div class="address-label">Wallet Anda:</div>
                    <div class="address" id="walletAddress"></div>
                </div>
                <div class="wallet-balance">
                    <div class="balance-label">Saldo BNB Anda:</div>
                    <div class="balance-value" id="ethBalance">-</div>
                </div>
                <div class="wallet-balance">
                    <div class="balance-label">Saldo DANA Anda:</div>
                    <div class="balance-value" id="danaBalance">-</div>
                </div>
            </div>

            <button class="btn btn-outline" id="addTokenBtnSmall">
                <i class="fas fa-plus-circle"></i> Add DANA to Wallet
            </button>
        </section>

        <section id="tokenInfo" class="card">
            <div class="card-title">
                <i class="fas fa-chart-line"></i>
                <span>Informasi Token Sale</span>
            </div>
            <div class="info-grid">
                <div class="info-item">
                    <div class="info-label">Harga per BNB</div>
                    <div class="info-value">
                        <span id="presaleRate">-</span> DANA
                    </div>
                </div>
                <div class="info-item">
                    <div class="info-label">Max Pembelian</div>
                    <div class="info-value" id="maxPurchase">-</div>
                </div>
                <div class="info-item">
                    <div class="info-label">Total Terjual</div>
                    <div class="info-value" id="totalSold">-</div>
                </div>
                <div class="info-item">
                    <div class="info-label">Hasil Penjualan</div>
                    <div class="info-value" id="weiRaised">-</div>
                </div>
                <div class="info-item-full">
                    <div class="info-label">Token Tersisa Untuk Dijual</div>
                    <div class="info-value" id="tokenBalance">-</div>
                </div>
            </div>
        </section>

        <section id="buyTokens" class="card">
            <div class="card-title">
                <i class="fas fa-shopping-cart"></i>
                <span>Beli Token DANA</span>
            </div>
            <form id="buyTokensForm">
                <div class="form-group">
                    <label for="buyAmount">Jumlah BNB:</label>
                    <input type="text" id="buyAmount" placeholder="Minimal 0.0003 BNB" required
                        oninput="limitMinimum(this)">
                    <div class="token-estimate">
                        Estimasi: <strong id="tokenEstimate">0</strong> DANA
                    </div>
                </div>
                <button type="submit" class="btn btn-primary" id="buyTokensBtn">
                    <i class="fas fa-check"></i> Beli DANA Sekarang
                </button>
            </form>
        </section>

        <footer class="footer">
            <div class="footer-links">
                <a href="https://dana.cryptoreceh.com/" class="footer-link" id="docsLink">
                    <i class="fas fa-book"></i> Docs
                </a>
                <a href="https://cryptoreceh.com/faq/" class="footer-link" id="tutorialLink">
                    <i class="fa-solid fa-file-circle-question"></i> FAQ
                </a>
                <a href="https://cryptoreceh.com/terms-of-service/" class="footer-link" id="contactLink">
                    <i class="fa-brands fa-readme"></i> Terms
                </a>
            </div>
            <div style="margin: 15px 0;">
                <button class="footer-action-btn" id="addChainBtn">
                    <i class="fa-brands fa-ethereum"></i> Add RPC BNB Chain
                </button>
            </div>
            <div class="copyright">
                &copy; 2025 CryptoRECEH.com
            </div>
        </footer>
    </main>

    <script>

        const TARGET_CHAIN_ID = '0x38';
        const TARGET_CHAIN_NAME = 'BNB Chain';
        const TOKEN_ADDRESS = '0x803658218208e9254A42bC62703EC3833c94690d';
        const PRESALE_ADDRESS = "0x3db1AC3d89C08B7f2081953505db759F86D0b927";
        const TOKEN_SYMBOL = 'DANA';
        const TOKEN_DECIMALS = 18;
        const TOKEN_LOGO_URL = 'https://raw.githubusercontent.com/cryptorecehcom/images/refs/heads/main/tokenlogo/DANA.png';
        const MINIMUM_PURCHASE = 0.0003;

        const contractABI = [
            {
                inputs: [
                    { internalType: "uint256", name: "_rate", type: "uint256" },
                    { internalType: "contract ERC20", name: "_token", type: "address" },
                    { internalType: "uint256", name: "_max", type: "uint256" },
                ],
                stateMutability: "nonpayable",
                type: "constructor",
            },
            {
                inputs: [{ internalType: "uint256", name: "_weiAmount", type: "uint256" }],
                name: "_getTokenAmount",
                outputs: [{ internalType: "uint256", name: "", type: "uint256" }],
                stateMutability: "view",
                type: "function",
            },
            {
                inputs: [
                    { internalType: "address", name: "_beneficiary", type: "address" },
                    { internalType: "uint256", name: "_weiAmount", type: "uint256" },
                ],
                name: "_preValidatePurchase",
                outputs: [{ internalType: "uint256", name: "", type: "uint256" }],
                stateMutability: "view",
                type: "function",
            },
            {
                inputs: [{ internalType: "address", name: "_beneficiary", type: "address" }],
                name: "buyTokens",
                outputs: [],
                stateMutability: "payable",
                type: "function",
            },
            {
                inputs: [{ internalType: "address", name: "_beneficiary", type: "address" }],
                name: "maxBnb",
                outputs: [{ internalType: "uint256", name: "", type: "uint256" }],
                stateMutability: "view",
                type: "function",
            },
            {
                inputs: [{ internalType: "address", name: "", type: "address" }],
                name: "purchasedBnb",
                outputs: [{ internalType: "uint256", name: "", type: "uint256" }],
                stateMutability: "view",
                type: "function",
            },
            {
                inputs: [],
                name: "rate",
                outputs: [{ internalType: "uint256", name: "", type: "uint256" }],
                stateMutability: "view",
                type: "function",
            },
            {
                inputs: [],
                name: "weiRaised",
                outputs: [{ internalType: "uint256", name: "", type: "uint256" }],
                stateMutability: "view",
                type: "function",
            }
        ];

        const tokenABI = [
            {
                constant: true,
                inputs: [{ name: "_owner", type: "address" }],
                name: "balanceOf",
                outputs: [{ name: "balance", type: "uint256" }],
                type: "function",
            },
            {
                constant: true,
                inputs: [],
                name: "decimals",
                outputs: [{ name: "", type: "uint8" }],
                type: "function",
            }
        ];

        let web3;
        let contract;
        let tokenContract;
        let userAccount = null;
        let presaleRate = 1;
        let isCorrectNetwork = false;

        document.addEventListener('DOMContentLoaded', function () {
            initializeApp();
        });

        async function initializeApp() {
            setupEventListeners();
            await loadContractData();

            if (window.ethereum) {
                checkWalletConnection();
            }
        }

        function setupEventListeners() {
            document.getElementById('connectWalletBtn').addEventListener('click', connectWallet);
            document.getElementById('switchNetworkBtn').addEventListener('click', switchNetwork);
            document.getElementById('buyTokensForm').addEventListener('submit', buyTokens);
            document.getElementById('buyAmount').addEventListener('input', updateTokenEstimate);
            document.getElementById('addTokenBtn').addEventListener('click', addTokenToWallet);
            document.getElementById('addTokenBtnSmall').addEventListener('click', addTokenToWallet);
            document.getElementById('addChainBtn').addEventListener('click', addChainToWallet);
            document.getElementById('notificationCloseBtn').addEventListener('click', closeNotification);
            document.getElementById('closeSuccessBtn').addEventListener('click', closeSuccessModal);
            document.getElementById('closeMobileBrowserModal').addEventListener('click', closeMobileBrowserModal);
            document.getElementById('copyUrlBtn').addEventListener('click', copyUrl);

            document.getElementById('docsLink').addEventListener('click', function (e) {
                e.preventDefault();
                showNotification('Info', 'Dokumentasi akan segera tersedia', 'info');
            });
            document.getElementById('tutorialLink').addEventListener('click', function (e) {
                e.preventDefault();
                showNotification('Info', 'Tutorial akan segera tersedia', 'info');
            });
            document.getElementById('contactLink').addEventListener('click', function (e) {
                e.preventDefault();
                showNotification('Info', 'Kontak akan segera tersedia', 'info');
            });

            if (window.ethereum) {
                window.ethereum.on('accountsChanged', function (accounts) {
                    if (accounts.length === 0) {
                        resetWalletConnection();
                    } else {
                        userAccount = accounts[0];
                        document.getElementById('walletAddress').textContent = formatAddress(userAccount);
                        if (isCorrectNetwork) {
                            loadUserData();
                        }
                    }
                });

                window.ethereum.on('chainChanged', function (chainId) {
                    location.reload();
                });
            }
        }

        function formatNumber(number) {
            if (isNaN(number) || number === null || number === undefined) return '-';
            const num = parseFloat(number);
            if (Number.isInteger(num)) {
                return num.toLocaleString();
            } else {
                return num.toFixed(2);
            }
        }

        function formatDecimal(number) {
            if (isNaN(number) || number === null || number === undefined) return '-';
            return parseFloat(number).toFixed(2);
        }

        function formatEth(number) {
            if (isNaN(number) || number === null || number === undefined) return '-';
            const num = parseFloat(number);
            if (num < 0.0001) {
                return '< 0.0001';
            } else {
                return num.toFixed(4);
            }
        }

        function formatAddress(address) {
            if (!address) return '';
            return address.substring(0, 6) + '...' + address.substring(address.length - 4);
        }

        async function checkWalletConnection() {
            if (!window.ethereum) return;

            try {
                const accounts = await window.ethereum.request({ method: 'eth_accounts' });
                if (accounts.length > 0) {
                    userAccount = accounts[0];
                    await checkNetwork();
                    if (isCorrectNetwork) {
                        showConnectedState();
                        await loadUserData();
                    }
                }
            } catch (error) {
                console.error('Error checking wallet connection:', error);
            }
        }

        async function connectWallet() {
            const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
            const hasWeb3 = typeof window.ethereum !== 'undefined';

            if (isMobile && !hasWeb3) {
                document.getElementById('mobileBrowserModal').style.display = 'flex';
                return;
            }

            if (!window.ethereum) {
                showNotification('Error', 'Install MetaMask atau wallet lainnya', 'error');
                return;
            }

            try {
                const accounts = await window.ethereum.request({ method: 'eth_requestAccounts' });
                userAccount = accounts[0];

                await checkNetwork();

                if (isCorrectNetwork) {
                    showConnectedState();
                    await loadUserData();
                    showNotification('Berhasil', 'Wallet terhubung!', 'success');
                } else {

                    showNetworkWarning();
                }
            } catch (error) {
                if (error.code === 4001) {
                    showNotification('Dibatalkan', 'Koneksi ditolak', 'error');
                } else {
                    showNotification('Error', 'Gagal menghubungkan wallet', 'error');
                }
            }
        }

        function showConnectedState() {
            document.getElementById('connectWallet').classList.add('hidden');
            document.getElementById('networkWarning').classList.add('hidden');
            document.getElementById('connectedWallet').classList.remove('hidden');
            document.getElementById('walletAddress').textContent = formatAddress(userAccount);
            stopBlinkAnimation();
        }

        function showNetworkWarning() {
            document.getElementById('connectWallet').classList.add('hidden');
            document.getElementById('connectedWallet').classList.add('hidden');
            document.getElementById('networkWarning').classList.remove('hidden');
            startBlinkAnimation();
        }

        function resetWalletConnection() {
            userAccount = null;
            isCorrectNetwork = false;
            document.getElementById('connectWallet').classList.remove('hidden');
            document.getElementById('connectedWallet').classList.add('hidden');
            document.getElementById('networkWarning').classList.add('hidden');
            stopBlinkAnimation();
        }

        async function checkNetwork() {
            if (!window.ethereum) return;

            try {
                const chainId = await window.ethereum.request({ method: 'eth_chainId' });
                const normalizedChainId = chainId.toLowerCase();
                const normalizedTargetChainId = TARGET_CHAIN_ID.toLowerCase();

                if (normalizedChainId === normalizedTargetChainId) {
                    isCorrectNetwork = true;
                    return true;
                } else {
                    isCorrectNetwork = false;
                    return false;
                }
            } catch (error) {
                console.error('Error checking network:', error);
                isCorrectNetwork = false;
                return false;
            }
        }

        async function switchNetwork() {
            if (!window.ethereum) {
                showNotification('Error', 'Wallet tidak terdeteksi', 'error');
                return;
            }

            try {
                await window.ethereum.request({
                    method: 'wallet_switchEthereumChain',
                    params: [{ chainId: TARGET_CHAIN_ID }],
                });

                setTimeout(async () => {
                    const networkCorrect = await checkNetwork();
                    if (networkCorrect) {
                        showConnectedState();
                        await loadUserData();
                        showNotification('Berhasil', 'Jaringan berhasil diganti!', 'success');
                    }
                }, 1000);
            } catch (switchError) {
                if (switchError.code === 4902) {
                    try {
                        await addChainToWallet();
                    } catch (addError) {
                        showNotification('Error', 'Gagal menambahkan jaringan', 'error');
                    }
                } else {
                    showNotification('Error', 'Gagal beralih jaringan', 'error');
                }
            }
        }

        async function addChainToWallet() {
            if (!window.ethereum) {
                showNotification('Error', 'Wallet tidak terdeteksi', 'error');
                return;
            }

            try {
                await window.ethereum.request({
                    method: 'wallet_addEthereumChain',
                    params: [
                        {
                            chainId: TARGET_CHAIN_ID,
                            chainName: TARGET_CHAIN_NAME,
                            rpcUrls: ['https://binance.llamarpc.com'],
                            nativeCurrency: {
                                name: 'BNB',
                                symbol: 'BNB',
                                decimals: 18
                            },
                            blockExplorerUrls: ['https://bscscan.com']
                        },
                    ],
                });
                showNotification('Berhasil', 'Jaringan berhasil ditambahkan!', 'success');
            } catch (addError) {
                showNotification('Error', 'Gagal menambahkan jaringan', 'error');
            }
        }

        function startBlinkAnimation() {
            const networkWarning = document.getElementById('networkWarning');
            const switchButton = document.getElementById('switchNetworkBtn');

            networkWarning.classList.add('network-warning-blink');
            switchButton.classList.add('btn-warning-blink');
        }

        function stopBlinkAnimation() {
            const networkWarning = document.getElementById('networkWarning');
            const switchButton = document.getElementById('switchNetworkBtn');

            networkWarning.classList.remove('network-warning-blink');
            switchButton.classList.remove('btn-warning-blink');
            networkWarning.style.transform = 'scale(1)';
        }

        async function loadContractData() {
            try {
                web3 = new Web3('https://binance.llamarpc.com');
                contract = new web3.eth.Contract(contractABI, PRESALE_ADDRESS);
                tokenContract = new web3.eth.Contract(tokenABI, TOKEN_ADDRESS);
                await loadGeneralData();
                await loadTokenBalance();
            } catch (error) {
                console.error('Error loading contract data:', error);
            }
        }

        async function loadGeneralData() {
            try {
                const rateWei = await contract.methods.rate().call();
                presaleRate = parseFloat(web3.utils.fromWei(rateWei, "ether"));
                document.getElementById("presaleRate").textContent = formatNumber(presaleRate);

                const weiRaisedWei = await contract.methods.weiRaised().call();
                const weiRaised = web3.utils.fromWei(weiRaisedWei, "ether");
                document.getElementById("weiRaised").textContent = formatNumber(parseFloat(weiRaised)) + " BNB";

                const totalSold = parseFloat(weiRaised) * presaleRate;
                document.getElementById("totalSold").textContent = formatNumber(totalSold) + " DANA";

                const maxPurchaseWei = await contract.methods.maxBnb("0x0000000000000000000000000000000000000000").call();
                const maxPurchase = web3.utils.fromWei(maxPurchaseWei, "ether");
                document.getElementById("maxPurchase").textContent = formatNumber(parseFloat(maxPurchase)) + " BNB";
            } catch (error) {
                console.error('Error loading general data:', error);
            }
        }

        async function loadTokenBalance() {
            try {
                const tokenBalanceWei = await tokenContract.methods.balanceOf(PRESALE_ADDRESS).call();
                const tokenBalance = web3.utils.fromWei(tokenBalanceWei, "ether");
                document.getElementById("tokenBalance").textContent = formatNumber(parseFloat(tokenBalance)) + " DANA";
            } catch (error) {
                console.error('Error loading token balance:', error);
                document.getElementById("tokenBalance").textContent = "Error";
            }
        }

        async function loadUserData() {
            if (!userAccount || !isCorrectNetwork) return;

            try {
                const userWeb3 = new Web3(window.ethereum);

                const maxPurchaseWei = await contract.methods.maxBnb(userAccount).call();
                const maxPurchase = userWeb3.utils.fromWei(maxPurchaseWei, "ether");
                document.getElementById("maxPurchase").textContent = formatNumber(parseFloat(maxPurchase)) + " BNB";

                const ethBalanceWei = await userWeb3.eth.getBalance(userAccount);
                const ethBalance = userWeb3.utils.fromWei(ethBalanceWei, "ether");
                document.getElementById("ethBalance").textContent = formatEth(parseFloat(ethBalance));

                const userTokenContract = new userWeb3.eth.Contract(tokenABI, TOKEN_ADDRESS);
                const danaBalanceWei = await userTokenContract.methods.balanceOf(userAccount).call();
                const danaBalance = userWeb3.utils.fromWei(danaBalanceWei, "ether");
                document.getElementById("danaBalance").textContent = formatEth(parseFloat(danaBalance));
            } catch (error) {
                console.error('Error loading user data:', error);
            }
        }

        function updateTokenEstimate() {
            const amount = parseFloat(document.getElementById('buyAmount').value) || 0;
            const estimate = amount * presaleRate;
            document.getElementById('tokenEstimate').textContent = formatDecimal(estimate);
        }

        async function buyTokens(event) {
            event.preventDefault();

            if (!userAccount) {
                showNotification('Error', 'Hubungkan wallet terlebih dahulu', 'error');
                return;
            }

            if (!isCorrectNetwork) {
                showNotification('Error', 'Silakan ganti ke jaringan BNB Chain terlebih dahulu', 'error');
                return;
            }

            const buyAmount = document.getElementById('buyAmount').value;
            const amount = parseFloat(buyAmount);

            if (!/^\d+(\.\d+)?$/.test(buyAmount) || amount < MINIMUM_PURCHASE) {
                showNotification('Error', `Masukkan jumlah minimal ${MINIMUM_PURCHASE} BNB`, 'error');
                return;
            }

            try {
                const submitBtn = document.getElementById('buyTokensBtn');
                submitBtn.innerHTML = '<span class="loader"></span> Processing...';
                submitBtn.disabled = true;

                const userWeb3 = new Web3(window.ethereum);
                const userContract = new userWeb3.eth.Contract(contractABI, PRESALE_ADDRESS);

                const userBalanceWei = await userWeb3.eth.getBalance(userAccount);
                const userBalance = parseFloat(userWeb3.utils.fromWei(userBalanceWei, "ether"));

                if (userBalance < amount) {
                    showNotification('Error', `Saldo BNB tidak cukup. Saldo Anda: ${formatEth(userBalance)} BNB`, 'error');
                    submitBtn.innerHTML = '<i class="fas fa-check"></i> Beli DANA Sekarang';
                    submitBtn.disabled = false;
                    return;
                }

                const maxPurchaseWei = await userContract.methods.maxBnb(userAccount).call();
                const maxPurchase = parseFloat(userWeb3.utils.fromWei(maxPurchaseWei, "ether"));

                if (amount > maxPurchase) {
                    showNotification('Error', `Jumlah melebihi batas pembelian. Maksimal: ${formatNumber(maxPurchase)} BNB`, 'error');
                    submitBtn.innerHTML = '<i class="fas fa-check"></i> Beli DANA Sekarang';
                    submitBtn.disabled = false;
                    return;
                }

                const result = await userContract.methods.buyTokens(userAccount).send({
                    from: userAccount,
                    value: userWeb3.utils.toWei(amount.toString(), "ether"),
                    gas: 100000,
                });

                const tokenAmount = amount * presaleRate;
                showSuccessModal(tokenAmount);

                document.getElementById('buyTokensForm').reset();
                document.getElementById('tokenEstimate').textContent = '0';
                await loadGeneralData();
                await loadUserData();
                await loadTokenBalance();

            } catch (error) {
                console.error('Error buying tokens:', error);

                let errorMessage = 'Gagal membeli token';

                if (error.code === 4001) {
                    errorMessage = 'Transaksi dibatalkan oleh pengguna';
                } else if (error.message) {
                    if (error.message.includes('insufficient funds')) {
                        errorMessage = 'Saldo BNB tidak cukup';
                    } else if (error.message.includes('max purchase')) {
                        errorMessage = 'Batas pembelian maksimum tercapai';
                    } else if (error.message.includes('revert')) {
                        errorMessage = 'Kontrak menolak transaksi. Cek jumlah dan coba lagi.';
                    } else if (error.message.includes('gas')) {
                        errorMessage = 'Error gas. Coba tingkatkan gas limit.';
                    }
                }

                showNotification('Error', errorMessage, 'error');
            } finally {
                const submitBtn = document.getElementById('buyTokensBtn');
                submitBtn.innerHTML = '<i class="fas fa-check"></i> Beli DANA Sekarang';
                submitBtn.disabled = false;
            }
        }

        function showSuccessModal(tokenAmount) {
            const message = document.getElementById('successMessage');
            message.textContent = `Berhasil membeli ${formatDecimal(tokenAmount)} DANA!`;
            document.getElementById('successPurchase').style.display = 'flex';
        }

        function closeSuccessModal() {
            document.getElementById('successPurchase').style.display = 'none';
        }

        function closeMobileBrowserModal() {
            document.getElementById('mobileBrowserModal').style.display = 'none';
        }

        async function addTokenToWallet() {
            if (!window.ethereum) {
                showNotification('Error', 'Wallet tidak terdeteksi', 'error');
                return;
            }

            try {

                const tokenParams = {
                    type: 'ERC20',
                    options: {
                        address: TOKEN_ADDRESS,
                        symbol: TOKEN_SYMBOL,
                        decimals: TOKEN_DECIMALS,
                        image: TOKEN_LOGO_URL
                    },
                };

                const wasAdded = await window.ethereum.request({
                    method: 'wallet_watchAsset',
                    params: tokenParams,
                });

                if (wasAdded) {
                    showNotification('Berhasil', 'Token DANA berhasil ditambahkan ke wallet!', 'success');
                    document.getElementById('successPurchase').style.display = 'none';
                } else {
                    showNotification('Info', 'Penambahan token dibatalkan', 'info');
                }
            } catch (error) {
                console.error('Error adding token to wallet:', error);

                // Fallback: coba tanpa image jika ada error
                if (error.message && error.message.includes('image')) {
                    try {
                        const fallbackParams = {
                            type: 'ERC20',
                            options: {
                                address: TOKEN_ADDRESS,
                                symbol: TOKEN_SYMBOL,
                                decimals: TOKEN_DECIMALS,
                            },
                        };

                        const wasAddedFallback = await window.ethereum.request({
                            method: 'wallet_watchAsset',
                            params: fallbackParams,
                        });

                        if (wasAddedFallback) {
                            showNotification('Berhasil', 'Token DANA berhasil ditambahkan (tanpa logo)', 'success');
                            document.getElementById('successPurchase').style.display = 'none';
                        } else {
                            showNotification('Info', 'Penambahan token dibatalkan', 'info');
                        }
                    } catch (fallbackError) {
                        showNotification('Error', 'Gagal menambahkan token ke wallet', 'error');
                    }
                } else {
                    showNotification('Error', 'Gagal menambahkan token ke wallet', 'error');
                }
            }
        }

        function copyUrl() {
            const url = window.location.href;
            navigator.clipboard.writeText(url).then(() => {
                showNotification('Berhasil', 'URL berhasil disalin!', 'success');
                document.getElementById('mobileBrowserModal').style.display = 'none';
            });
        }

        function showNotification(title, message, type) {
            const modal = document.getElementById('notificationModal');
            const icon = document.getElementById('notificationIcon');
            const titleEl = document.getElementById('notificationTitle');
            const messageEl = document.getElementById('notificationMessage');

            icon.innerHTML = '';
            let iconClass = '';
            if (type === 'success') {
                iconClass = 'notification-success';
                icon.innerHTML = '<i class="fas fa-check-circle ' + iconClass + '"></i>';
            } else if (type === 'error') {
                iconClass = 'notification-error';
                icon.innerHTML = '<i class="fas fa-exclamation-circle ' + iconClass + '"></i>';
            } else {
                iconClass = 'notification-info';
                icon.innerHTML = '<i class="fas fa-info-circle ' + iconClass + '"></i>';
            }

            titleEl.textContent = title;
            messageEl.textContent = message;
            modal.style.display = 'flex';
        }

        function closeNotification() {
            document.getElementById('notificationModal').style.display = 'none';
        }

        function limitMinimum(el) {
            el.value = el.value.replace(/[^0-9.]/g, '').replace(/(\..*)\./g, '$1');
            const min = MINIMUM_PURCHASE;

            if (el.value === '' || el.value === '.' || el.value === '0.' || (el.value.startsWith('0.0') && el.value.length < 6)) {
                return;
            }

            const val = parseFloat(el.value);
            if (!isNaN(val) && val < min) {
                el.value = min.toString();
            }
        }
    </script>
</body>

</html>
